<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Category Full Debug</title>
    <style>
        .debug-panel { 
            background: #f0f0f0; 
            padding: 15px; 
            margin: 10px 0; 
            font-family: monospace; 
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
        .info { background: #e6f3ff; color: #006; }
        .step { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
    </style>
</head>
<body>
    <h1>Tour Category Complete Debug</h1>
    <div id="debug-panel" class="debug-panel info">Starting debug session...</div>
    
    <h2>Mount Points</h2>
    <div id="skeleton" class="skeleton-list" aria-hidden="true">SKELETON LOADING...</div>
    <div id="tour-list" class="tour-list" hidden aria-live="polite">TOUR LIST PLACEHOLDER</div>

    <script>
    // Complete debugging setup
    const debugPanel = document.getElementById('debug-panel');
    
    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const div = document.createElement('div');
        div.className = `step ${type}`;
        div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        debugPanel.appendChild(div);
        debugPanel.scrollTop = debugPanel.scrollHeight;
        console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
    }
    
    // Test 1: Basic setup
    log('=== STEP 1: Initial Setup ===');
    log(`Document ready state: ${document.readyState}`);
    log(`Mount points exist: skeleton=${!!document.getElementById('skeleton')}, tour-list=${!!document.getElementById('tour-list')}`);
    
    // Test 2: Configuration  
    window.CFG = {
        client: 'tour-driver',
        fallbackUrl: 'https://tour-driver-data-proxy.krishna-0a3.workers.dev',
        FILTER: { mode: 'type', value: 'Food & Culinary' },
        LIST_SELECTOR: '#tour-list'
    };
    
    log('=== STEP 2: Configuration Set ===');
    log(`window.CFG: ${JSON.stringify(window.CFG, null, 2)}`);
    
    // Test 3: API connectivity
    log('=== STEP 3: Testing API Directly ===');
    setTimeout(async () => {
        try {
            log('Fetching from API...');
            const response = await fetch(window.CFG.fallbackUrl, { 
                cache: 'no-store',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            log(`API Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
            log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);
            
            if (response.ok) {
                const data = await response.json();
                log(`API data received: ${data.tours ? data.tours.length : 0} tours`, 'success');
                
                if (data.tours && data.tours.length > 0) {
                    const sample = data.tours[0];
                    log(`Sample tour structure: ${Object.keys(sample).join(', ')}`);
                    
                    // Test filtering
                    const filtered = data.tours.filter(tour => {
                        const typeMatch = tour.type === window.CFG.FILTER.value;
                        const categoryMatch = tour.category === window.CFG.FILTER.value;
                        return typeMatch || categoryMatch;
                    });
                    log(`Filtered tours for "${window.CFG.FILTER.value}": ${filtered.length}`, filtered.length > 0 ? 'success' : 'error');
                    
                    if (filtered.length > 0) {
                        log(`Sample filtered tour: ${filtered[0].name || filtered[0].title || 'No name field'}`);
                    }
                } else {
                    log('API returned empty tours array', 'error');
                }
            } else {
                const text = await response.text();
                log(`API Error body: ${text.substring(0, 200)}`, 'error');
            }
        } catch (error) {
            log(`API Error: ${error.message}`, 'error');
        }
    }, 1000);
    
    // Monitor component loading
    log('=== STEP 4: Loading Component ===');
    const startTime = Date.now();
    let componentLoaded = false;
    
    const monitor = setInterval(() => {
        const elapsed = Math.round((Date.now() - startTime) / 1000);
        
        // Check if component loaded
        if (window.TourCategory && !componentLoaded) {
            componentLoaded = true;
            log('✅ TourCategory object detected!', 'success');
        }
        
        // Check CFG changes
        if (window.CFG && window.CFG.DATA_URL && window.CFG.DATA_URL !== window.CFG.fallbackUrl) {
            log(`✅ DATA_URL was set by component: ${window.CFG.DATA_URL}`, 'success');
        }
        
        // Check UI state
        const skeleton = document.getElementById('skeleton');
        const tourList = document.getElementById('tour-list');
        const skeletonHidden = skeleton.hasAttribute('aria-hidden') && skeleton.getAttribute('aria-hidden') === 'true';
        const tourListVisible = !tourList.hasAttribute('hidden') || tourList.hasAttribute('hidden') === false;
        const tourListContent = tourList.innerHTML;
        
        log(`[${elapsed}s] skeleton hidden: ${skeletonHidden}, tour-list visible: ${tourListVisible}, content: ${tourListContent.length > 50 ? 'HAS CONTENT' : 'empty'}`);
        
        // Stop after 30 seconds
        if (elapsed > 30) {
            clearInterval(monitor);
            log('=== FINAL STATUS ===', 'error');
            log(`Component loaded: ${!!window.TourCategory}`);
            log(`CFG final state: ${JSON.stringify(window.CFG, null, 2)}`);
            log(`Tours loaded: ${tourListContent.length > 50}`);
        }
    }, 2000);
    
    </script>

    <!-- Load the component -->
    <script src="https://cdn.jsdelivr.net/gh/krishnalewin-hash/tourism-ui-kit@8bb3636/dist/tour-category-page.min.js"></script>
    
    <script>
    // Post-load checks
    window.addEventListener('load', () => {
        setTimeout(() => {
            log('=== POST-LOAD ANALYSIS ===');
            log(`Final window.CFG: ${JSON.stringify(window.CFG, null, 2)}`);
            log(`TourCategory available: ${!!window.TourCategory}`);
            
            const tourList = document.getElementById('tour-list');
            if (tourList.innerHTML.includes('Configuration Error')) {
                log('❌ Component showed configuration error', 'error');
            } else if (tourList.innerHTML.length > 100) {
                log('✅ Component rendered content', 'success');
            } else {
                log('⚠️ Component loaded but no content rendered', 'error');
            }
        }, 3000);
    });
    </script>
</body>
</html>