<!DOCTYPE html>
<html>
<head>
    <title>Step-by-Step Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .step { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #007cba; }
        .success { border-left-color: #28a745; background: #f8fff9; }
        .error { border-left-color: #dc3545; background: #fff8f8; }
        .warning { border-left-color: #ffc107; background: #fffbf0; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
        #console-output { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Quote Calculator Diagnostic</h1>
    
    <div id="step1" class="step">
        <h3>Step 1: Basic HTML Loading</h3>
        <p>Status: <span id="step1-status">Testing...</span></p>
    </div>
    
    <div id="step2" class="step">
        <h3>Step 2: JavaScript Execution</h3>
        <p>Status: <span id="step2-status">Testing...</span></p>
    </div>
    
    <div id="step3" class="step">
        <h3>Step 3: Configuration Setup</h3>
        <p>Status: <span id="step3-status">Testing...</span></p>
    </div>
    
    <div id="step4" class="step">
        <h3>Step 4: Quote Calculator File Loading</h3>
        <p>Status: <span id="step4-status">Testing...</span></p>
    </div>
    
    <div id="step5" class="step">
        <h3>Step 5: Mount Point Detection</h3>
        <p>Status: <span id="step5-status">Testing...</span></p>
    </div>
    
    <div id="step6" class="step">
        <h3>Step 6: URL Parameters</h3>
        <p>Status: <span id="step6-status">Testing...</span></p>
    </div>
    
    <h3>Console Output:</h3>
    <div id="console-output"></div>
    
    <h3>Mount Point:</h3>
    <div id="quote-calc" style="border: 2px dashed #ccc; padding: 20px; background: white; border-radius: 8px;">
        Quote calculator mount point - should be replaced by widget
    </div>
    
    <script>
        // Console capture
        const consoleOutput = document.getElementById('console-output');
        function log(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.innerHTML += `<div>[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console[type](message);
        }
        
        // Override console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) { log(args.join(' '), 'log'); originalLog.apply(console, args); };
        console.error = function(...args) { log(args.join(' '), 'error'); originalError.apply(console, args); };
        console.warn = function(...args) { log(args.join(' '), 'warn'); originalWarn.apply(console, args); };
        
        // Catch unhandled errors
        window.addEventListener('error', function(event) {
            log(`ERROR: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });
        
        function updateStep(stepNum, status, className = '') {
            const element = document.getElementById(`step${stepNum}-status`);
            element.textContent = status;
            const stepDiv = document.getElementById(`step${stepNum}`);
            stepDiv.className = `step ${className}`;
        }
        
        // Step 1: Basic HTML
        updateStep(1, 'HTML loaded successfully ✅', 'success');
        log('Step 1: Basic HTML loading complete');
        
        // Step 2: JavaScript
        try {
            updateStep(2, 'JavaScript execution working ✅', 'success');
            log('Step 2: JavaScript execution confirmed');
        } catch (e) {
            updateStep(2, `JavaScript error: ${e.message} ❌`, 'error');
            log(`Step 2 failed: ${e.message}`, 'error');
        }
        
        // Step 3: Configuration
        try {
            window.CFG = {
                GMAPS_KEY: "AIzaSyD4gsEcGYTjqAILBU0z3ZNqEwyODGymXjA"
            };
            updateStep(3, 'Configuration set ✅', 'success');
            log('Step 3: Configuration setup complete');
            log(`API Key: ${window.CFG.GMAPS_KEY.substring(0, 20)}...`);
        } catch (e) {
            updateStep(3, `Configuration error: ${e.message} ❌`, 'error');
            log(`Step 3 failed: ${e.message}`, 'error');
        }
        
        // Step 4: Check if files load
        let cssLoaded = false;
        let jsLoaded = false;
        
        // Test CSS loading
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '../dist/quote-calc.css';
        link.onload = function() {
            cssLoaded = true;
            log('CSS file loaded successfully');
            checkFilesLoaded();
        };
        link.onerror = function() {
            updateStep(4, 'CSS file failed to load ❌', 'error');
            log('CSS file failed to load', 'error');
        };
        document.head.appendChild(link);
        
        // Test JS loading
        const script = document.createElement('script');
        script.src = '../dist/quote-calc.js';
        script.onload = function() {
            jsLoaded = true;
            log('JavaScript file loaded successfully');
            checkFilesLoaded();
        };
        script.onerror = function() {
            updateStep(4, 'JavaScript file failed to load ❌', 'error');
            log('JavaScript file failed to load', 'error');
        };
        document.head.appendChild(script);
        
        function checkFilesLoaded() {
            if (cssLoaded && jsLoaded) {
                updateStep(4, 'CSS and JS files loaded ✅', 'success');
                log('Step 4: All files loaded successfully');
                
                // Wait a bit then check for quote calculator
                setTimeout(checkQuoteCalculator, 1000);
            }
        }
        
        function checkQuoteCalculator() {
            // Step 5: Mount point
            const mountPoint = document.getElementById('quote-calc');
            if (mountPoint) {
                updateStep(5, 'Mount point found ✅', 'success');
                log('Step 5: Mount point detected');
            } else {
                updateStep(5, 'Mount point missing ❌', 'error');
                log('Step 5 failed: No mount point found', 'error');
                return;
            }
            
            // Step 6: URL parameters
            const params = new URLSearchParams('?pickup_location=MBJ Airport&dropoff_location=Negril&passengers=3');
            window.history.replaceState({}, '', '?' + params.toString());
            
            updateStep(6, 'URL parameters set ✅', 'success');
            log('Step 6: URL parameters configured');
            log(`Pickup: ${params.get('pickup_location')}`);
            log(`Dropoff: ${params.get('dropoff_location')}`);
            log(`Passengers: ${params.get('passengers')}`);
            
            // Check if QuoteCalc exists
            setTimeout(() => {
                if (window.QuoteCalc) {
                    log('QuoteCalc object found - attempting manual trigger');
                    try {
                        window.QuoteCalc.run();
                        log('Manual QuoteCalc.run() executed');
                    } catch (e) {
                        log(`QuoteCalc.run() failed: ${e.message}`, 'error');
                    }
                } else {
                    log('QuoteCalc object not found - script may not have executed', 'error');
                }
            }, 2000);
        }
        
        log('Diagnostic started - monitoring for 10 seconds...');
    </script>
</body>
</html>