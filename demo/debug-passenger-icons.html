<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Passenger Icon Issue</title>
  <style>
    body { padding: 20px; font-family: Arial, sans-serif; }
    .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
    .step { border-left: 3px solid #007cba; padding-left: 10px; margin: 5px 0; }
    input, select { padding: 10px; margin: 10px 0; display: block; width: 300px; }
    .icon-count { font-weight: bold; color: red; }
  </style>
</head>
<body>
  <h1>Debug: Passenger Icon Duplication</h1>
  
  <div id="debug-log" class="debug">
    <div class="step">Starting debug...</div>
  </div>

  <form>
    <input type="text" data-q="pickup_location" placeholder="Pickup Location" />
    <input type="text" data-q="drop-off_location" placeholder="Drop-off Location" />
    <input type="text" data-q="pickup_date" placeholder="Pickup Date" />
    <input type="text" data-q="pickup_time" placeholder="Pickup Time" />
    <input type="number" data-q="number_of_passengers" placeholder="Number of Passengers" />
  </form>

  <script>
    window.CFG = {
      client: 'kamar-tours'
    };
    
    // Enable debug logging
    window.__debugPassengerSelect = true;

    const debugLog = document.getElementById('debug-log');
    
    function addLog(message, isError = false) {
      const div = document.createElement('div');
      div.className = 'step';
      if (isError) div.style.color = 'red';
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      debugLog.appendChild(div);
      console.log(message);
    }

    function countIcons() {
      const passengerIcons = document.querySelectorAll('.field-icon[data-for="number_of_passengers"]');
      const allIcons = document.querySelectorAll('.field-icon');
      const passengerInputs = document.querySelectorAll('input[data-q="number_of_passengers"]');
      const passengerSelects = document.querySelectorAll('select[data-q="number_of_passengers"]');
      const iconWrappers = document.querySelectorAll('.icon-field-wrapper');
      
      return {
        passengerIcons: passengerIcons.length,
        allIcons: allIcons.length,
        passengerInputs: passengerInputs.length,
        passengerSelects: passengerSelects.length,
        iconWrappers: iconWrappers.length,
        elements: { passengerIcons, allIcons, passengerInputs, passengerSelects, iconWrappers }
      };
    }

    function logState(label) {
      const counts = countIcons();
      addLog(`${label}: ${counts.passengerIcons} passenger icons, ${counts.passengerInputs} inputs, ${counts.passengerSelects} selects, ${counts.iconWrappers} wrappers`);
      
      if (counts.passengerIcons > 1) {
        addLog(`⚠️  DUPLICATE ICONS DETECTED! Investigating...`, true);
        
        counts.elements.passengerIcons.forEach((icon, i) => {
          const wrapper = icon.closest('.icon-field-wrapper');
          const input = wrapper?.querySelector('input[data-q="number_of_passengers"]');
          const select = wrapper?.querySelector('select[data-q="number_of_passengers"]');
          
          addLog(`  Icon ${i+1}: wrapper=${!!wrapper}, input=${!!input} (visible: ${input ? getComputedStyle(input).display !== 'none' : 'N/A'}), select=${!!select}`, true);
        });
      }
    }

    // Monitor before script load
    addLog('BEFORE script load');
    logState('Initial state');

    // Track when select field disappears
    const trackSelectDisappearance = () => {
      const selectExists = !!document.querySelector('select[data-q="number_of_passengers"]');
      const currentTime = new Date().toLocaleTimeString();
      
      if (!selectExists && window.__selectWasPresent) {
        addLog(`🚨 SELECT FIELD DISAPPEARED at ${currentTime}!`, true);
        logState('After select disappeared');
        
        // Log what's left
        const input = document.querySelector('input[data-q="number_of_passengers"]');
        const wrapper = document.querySelector('.icon-field-wrapper');
        addLog(`Remaining: input=${!!input}, wrapper=${!!wrapper}`, true);
        if (input) {
          addLog(`Input state: visible=${getComputedStyle(input).display !== 'none'}, wired=${input.dataset.paxSelectWired}`, true);
        }
      } else if (selectExists) {
        window.__selectWasPresent = true;
      }
    };

    // Check every 100ms for disappearance
    setInterval(trackSelectDisappearance, 100);

    // Override key functions to track when they run
    const originalEnhanceVisual = window.enhanceVisual;
    const originalAttachPassengerSelect = window.attachPassengerSelect;

    // Set up monitoring
    let scriptLoaded = false;
    const checkInterval = setInterval(() => {
      if (window.enhanceVisual && !scriptLoaded) {
        scriptLoaded = true;
        addLog('Script loaded, setting up monitoring...');

        // Override enhanceVisual
        const originalEV = window.enhanceVisual;
        window.enhanceVisual = function(rootDoc) {
          addLog('🎨 enhanceVisual() called');
          logState('Before enhanceVisual');
          const result = originalEV.call(this, rootDoc);
          logState('After enhanceVisual');
          return result;
        };

        // Override passenger select attach
        if (window.__passengerSelect?.attach) {
          const originalPS = window.__passengerSelect.attach;
          window.__passengerSelect.attach = function(rootDoc) {
            addLog('🔄 attachPassengerSelect() called');
            logState('Before attachPassengerSelect');
            const result = originalPS.call(this, rootDoc);
            logState('After attachPassengerSelect');
            return result;
          };
        }
      }
    }, 50);

    // Stop monitoring after 10 seconds
    setTimeout(() => {
      clearInterval(checkInterval);
      addLog('Monitoring stopped');
      logState('Final state');
    }, 10000);

    // Also monitor DOM changes
    const observer = new MutationObserver(() => {
      const counts = countIcons();
      if (counts.passengerIcons > 1) {
        addLog(`🚨 DOM change detected - ${counts.passengerIcons} passenger icons now exist!`, true);
        logState('After DOM change');
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  </script>

  <!-- Load the tour-detail-form script -->
  <script src="https://cdn.jsdelivr.net/gh/krishnalewin-hash/tourism-ui-kit@e297dad/src/tour-detail-form/js/tour-detail-form.js"></script>

  <script>
    setTimeout(() => {
      addLog('AFTER script load (immediate)');
      logState('After script load');
    }, 0);

    setTimeout(() => {
      addLog('AFTER 500ms delay');
      logState('After 500ms');
    }, 500);

    setTimeout(() => {
      addLog('AFTER 1000ms delay');
      logState('After 1000ms');
    }, 1000);
  </script>
</body>
</html>